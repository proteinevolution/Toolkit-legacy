#! /usr/bin/perl -w
# Add TER line to pdb file generated by modeller and optionally add offset to ATOM residue indices 
# Usage:   repair_pdb.pl pdb-file

use strict;

print("Add TER line to pdb file generated by modeller and optionally add offset to ATOM residue indices\n");

my @res;
my $line;
# check arguments
if ( @ARGV < 1 ) {
	error();
	exit(1);
}
my $offset=0;
if (@ARGV>=2) {$offset=$ARGV[1];}

open( IN, "<$ARGV[0]" ) or die("Cannot open!");
while ($line=<IN>) {
    if ($offset && $line=~/^ATOM .{17}\s*(\d+)/) {
	my $nres = sprintf("%4i",$1+$offset);
	$line=~s/^(.{22})..../$1$nres/;
    }
    push(@res,$line);
}
close(IN);


my $i = scalar(@res) - 2; 
$line = $res[$i];         # last line before END record

if ($line!~/^TER/) {

    $line =~ s/^ATOM(\s+\d+)\s+\S+\s+(\S+\s+\d+).*\s+(\S+)\s*$/TER $1      $2                                               $3/;
    $line =~ /^\S+\s+(\d+)/;
    my $tmp = $1;
    my $tmp1 = $tmp + 1;
    my $tmp2 = $tmp + 2;
    $line =~ s/$tmp1/$tmp2/;
    $line =~ s/$tmp/$tmp1/;
    
    $res[++$i] = "$line\n";  # add TER line
    $res[++$i] = "END\n";
}

open( OUT, ">$ARGV[0]" ) or die("Cannot open!");
print OUT @res;
close OUT;

print "FINISHED!!!!\n";

exit(0);

#####################################################
#### sub functions

sub error {
	print("Usage: repair_pdb.pl pdb-file [residue-offset]\n");
	print("\n");
}
